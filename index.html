<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gmail Hub LK</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --primary: #0088cc; --success: #27ae60; --dark: #1c1c1c; --gray: #f4f4f7; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--gray); margin: 0; padding: 15px; color: #333; }
        .card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; }
        
        .profile-row { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
        .avatar { width: 45px; height: 45px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; }
        .user-meta b { display: block; font-size: 16px; }
        .user-meta span { font-size: 11px; color: #888; background: #eee; padding: 2px 6px; border-radius: 4px; }
        
        .balance-label { font-size: 12px; color: #888; text-transform: uppercase; margin-top: 10px; }
        .balance-value { font-size: 32px; font-weight: 800; color: var(--primary); }
        
        button { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-claim { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(0,136,204,0.3); }
        .btn-claim:disabled { background: #ccc; box-shadow: none; }
        
        .status-bar { text-align: center; font-size: 12px; color: #999; margin-top: 10px; }
    </style>
</head>
<body>

<div class="card">
    <div class="profile-row">
        <div class="avatar" id="u-avatar">?</div>
        <div class="user-meta">
            <b id="u-name">Unknown User</b>
            <span id="u-id">ID: 000000000</span>
        </div>
    </div>
    <div class="balance-label">Total Earnings</div>
    <div class="balance-value">Rs. <span id="u-balance">0.00</span></div>
</div>

<div id="action-area">
    <button class="btn-claim" id="claim-btn" onclick="handleClaim()">Get New Account</button>
    <div class="status-bar" id="status-text">Connecting to system...</div>
</div>

<div id="history-area" style="margin-top: 20px;"></div>

<script>
    const SB_URL = "https://uohkgkcykfcyavmafbai.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvaGtna2N5kZjeWF2bWFmYmFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyOTI5NDksImV4cCI6MjA4NTg2ODk0OX0.syN_lHByHWE2KolyK6snm5jIML68HFxBisHKnZthNHw";
    
    const { createClient } = supabase;
    const client = createClient(SB_URL, SB_KEY);
    const tg = window.Telegram.WebApp;

    async function initApp() {
        tg.ready();
        tg.expand();

        const user = tg.initDataUnsafe?.user;

        if (user) {
            // Update UI
            document.getElementById('u-name').innerText = user.first_name;
            document.getElementById('u-id').innerText = "ID: " + user.id;
            document.getElementById('u-avatar').innerText = user.first_name.charAt(0);

            try {
                // Sync user with Supabase
                await client.from('profiles').upsert({ 
                    telegram_id: user.id, 
                    username: user.username || "none" 
                });

                // Load User Data
                const { data: profile } = await client.from('profiles').select('*').eq('telegram_id', user.id).single();
                if (profile) {
                    document.getElementById('u-balance').innerText = profile.balance.toFixed(2);
                }
                
                document.getElementById('status-text').innerText = "System Online";
            } catch (err) {
                document.getElementById('status-text').innerText = "Database Error";
            }
        } else {
            document.getElementById('u-name').innerText = "Desktop Preview";
            document.getElementById('status-text').innerText = "Please open in Telegram";
        }
    }

    async function handleClaim() {
        const user = tg.initDataUnsafe?.user;
        if (!user) return alert("Use Telegram!");

        document.getElementById('claim-btn').disabled = true;
        document.getElementById('status-text').innerText = "Checking stock...";

        const { data: acc, error } = await client.from('accounts').select('*').eq('status', 'available').limit(1).single();

        if (acc) {
            tg.showAlert("Account assigned: " + acc.email);
            // Add your locking logic here
        } else {
            tg.showAlert("Out of stock!");
            document.getElementById('claim-btn').disabled = false;
        }
        document.getElementById('status-text').innerText = "Process Complete";
    }

    window.onload = initApp;
</script>
</body>
</html>
