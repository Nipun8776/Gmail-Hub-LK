<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title> Gmail Hub LK  </title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        html { overflow-x: hidden; width: 100%; }
        
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 100; display: none; justify-content: center; align-items: center; }
        #confirm-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 200; display: none; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(2px); }
        .sticky-header { position: sticky; top: 70px; z-index: 40; background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Loading Overlay -->
    <div id="loading-overlay"><div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent"></div></div>

    <!-- Dynamic Confirmation Modal -->
    <div id="confirm-modal" class="hidden">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full text-center fade-in border border-gray-100 transform transition-all scale-100 relative overflow-hidden">
            <div id="modal-top-line" class="absolute top-0 left-0 w-full h-2 bg-blue-500"></div>
            
            <div id="modal-icon-bg" class="mb-5 bg-blue-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto shadow-sm transition-colors">
                <i id="modal-icon" class="fa-solid fa-circle-question text-4xl text-blue-600"></i>
            </div>
            
            <h3 class="text-xl font-bold text-gray-800 mb-2" id="modal-title">Confirm Action</h3>
            <p class="text-gray-500 text-sm mb-6 leading-relaxed" id="modal-desc">
                Are you sure you want to proceed?
            </p>
            
            <div class="flex gap-3">
                <button id="modal-btn-cancel" class="flex-1 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold rounded-xl active:scale-95 transition text-sm">Cancel</button>
                <button id="modal-btn-yes" class="flex-1 py-3 text-white font-bold rounded-xl shadow-lg active:scale-95 transition text-sm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="bg-slate-900 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-center items-center mb-3">
                <h1 class="text-xl font-bold tracking-widest text-center uppercase">Gmail Hub LK </h1>
            </div>
            
            <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar w-full justify-start md:justify-center">
                <button onclick="switchTab('dashboard')" id="btn-dashboard" class="nav-btn bg-blue-600 text-white min-w-[100px] px-4 py-2.5 rounded-lg text-xs font-bold uppercase tracking-wider transition-all duration-200 shadow-md">Dashboard</button>
                <button onclick="switchTab('qc')" id="btn-qc" class="nav-btn text-gray-400 hover:bg-slate-800 min-w-[90px] px-4 py-2.5 rounded-lg text-xs font-bold uppercase tracking-wider transition-all duration-200 border border-slate-700">QC Check</button>
                <button onclick="switchTab('payments')" id="btn-payments" class="nav-btn text-gray-400 hover:bg-slate-800 min-w-[90px] px-4 py-2.5 rounded-lg text-xs font-bold uppercase tracking-wider transition-all duration-200 border border-slate-700">Payments</button>
                <button onclick="switchTab('issues')" id="btn-issues" class="nav-btn text-gray-400 hover:bg-slate-800 min-w-[90px] px-4 py-2.5 rounded-lg text-xs font-bold uppercase tracking-wider transition-all duration-200 border border-slate-700">Issues</button>
                <button onclick="switchTab('stock')" id="btn-stock" class="nav-btn text-gray-400 hover:bg-slate-800 min-w-[90px] px-4 py-2.5 rounded-lg text-xs font-bold uppercase tracking-wider transition-all duration-200 border border-slate-700">Stock</button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-3 md:p-6 flex-1 flex flex-col max-w-7xl">
        
        <!-- Controls Row -->
        <div class="sticky-header pt-2 pb-2">
            <div class="relative shadow-sm">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fa-solid fa-search text-gray-400"></i></span>
                <input type="text" id="global-search" onkeyup="handleSearch()" placeholder="Search #ID or Email..." class="w-full py-3 pl-10 pr-10 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow">
                <button onclick="clearSearch()" id="clear-search-btn" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-red-500 hidden transition"><i class="fa-solid fa-circle-xmark text-lg"></i></button>
            </div>
        </div>

        <div id="view-search" class="hidden fade-in pb-10">
            <div class="flex items-center justify-between border-b pb-2 mb-4"><h3 class="text-sm font-bold text-gray-500 uppercase tracking-widest">Search Results</h3><span id="search-count" class="bg-gray-200 text-gray-600 py-0.5 px-2 rounded text-xs font-bold">0</span></div>
            <div id="search-results-container" class="space-y-3"></div>
        </div>

        <!-- DASHBOARD -->
        <div id="view-dashboard" class="fade-in flex flex-col h-full">
            <div class="grid grid-cols-3 md:grid-cols-6 gap-3 mb-6 shrink-0">
                <div class="bg-white p-3 rounded-xl shadow-sm border-b-4 border-blue-500"><p class="text-gray-400 text-[10px] uppercase font-bold tracking-wide">Stock</p><h2 class="text-xl font-bold text-gray-800" id="stat-available">0</h2></div>
                <div class="bg-white p-3 rounded-xl shadow-sm border-b-4 border-yellow-500"><p class="text-gray-400 text-[10px] uppercase font-bold tracking-wide">Work</p><h2 class="text-xl font-bold text-gray-800" id="stat-progress">0</h2></div>
                <div class="bg-white p-3 rounded-xl shadow-sm border-b-4 border-green-500"><p class="text-gray-400 text-[10px] uppercase font-bold tracking-wide">To QC</p><h2 class="text-xl font-bold text-gray-800" id="stat-completed">0</h2></div>
                <div class="bg-white p-3 rounded-xl shadow-sm border-b-4 border-emerald-500"><p class="text-gray-400 text-[10px] uppercase font-bold tracking-wide">Verified</p><h2 class="text-xl font-bold text-emerald-600" id="stat-verified">0</h2></div>
                <div class="bg-white p-3 rounded-xl shadow-sm border-b-4 border-indigo-500"><p class="text-gray-400 text-[10px] uppercase font-bold tracking-wide">Paid</p><h2 class="text-xl font-bold text-indigo-600" id="stat-paid">0</h2></div>
                <div class="bg-white p-3 rounded-xl shadow-sm border-b-4 border-red-500"><p class="text-gray-400 text-[10px] uppercase font-bold tracking-wide">Issues</p><h2 class="text-xl font-bold text-red-600" id="stat-issues">0</h2></div>
            </div>

            <div class="flex flex-col md:flex-row gap-6 h-full">
                <!-- Left Panel -->
                <div class="md:w-1/3 flex flex-col gap-5">
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-blue-50 text-center relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-blue-500"></div>
                        <h3 class="text-sm font-bold text-gray-700 mb-3 uppercase tracking-wide">Request Account</h3>
                        <button onclick="getNewAccount()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-200 active:scale-95 transition-all flex items-center justify-center gap-2 uppercase tracking-wide text-sm">
                            <i class="fa-solid fa-plus-circle"></i> Get New Email
                        </button>
                        <p id="error-msg" class="text-red-500 text-xs mt-3 hidden font-bold bg-red-100 py-1 px-3 rounded-lg inline-block">NO STOCK AVAILABLE!</p>
                    </div>

                    <!-- Earnings -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
                        <h4 class="text-xs font-bold text-gray-500 uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-coins text-yellow-500"></i> Earnings</h4>
                        <div class="space-y-2 mb-4">
                            <div class="flex items-center justify-between bg-gray-50 p-2 rounded border border-gray-100">
                                <label class="text-[10px] font-bold text-gray-500">1 USD (Rs):</label>
                                <input type="number" id="usd-rate" value="300" onchange="saveSettings()" class="w-16 bg-transparent text-xs font-bold text-right outline-none text-gray-700 border-b border-gray-300 focus:border-blue-500">
                            </div>
                            <div class="flex items-center justify-between bg-gray-50 p-2 rounded border border-gray-100">
                                <label class="text-[10px] font-bold text-gray-500">Revenue ($):</label>
                                <input type="number" step="0.01" id="revenue-rate" value="0.25" onchange="saveSettings()" class="w-16 bg-transparent text-xs font-bold text-right outline-none text-gray-700 border-b border-gray-300 focus:border-blue-500">
                            </div>
                            <div class="flex items-center justify-between bg-gray-50 p-2 rounded border border-gray-100">
                                <label class="text-[10px] font-bold text-gray-500">Worker Pay (Rs):</label>
                                <input type="number" id="worker-pay" value="40" onchange="saveSettings()" class="w-16 bg-transparent text-xs font-bold text-right outline-none text-gray-700 border-b border-gray-300 focus:border-blue-500">
                            </div>
                        </div>

                        <div class="space-y-3 pt-2 border-t border-dashed border-gray-200">
                            <div class="flex justify-between items-center text-xs">
                                <span class="text-gray-500 font-medium">Total Revenue</span>
                                <div class="text-right">
                                    <div class="font-bold text-gray-800" id="fin-revenue-usd">$0.00</div>
                                    <div class="text-[10px] text-gray-400 font-mono" id="fin-revenue-lkr">Rs. 0.00</div>
                                </div>
                            </div>
                            <div class="flex justify-between items-center text-xs">
                                <span class="text-gray-500 font-medium">Worker Cost</span>
                                <div class="text-right">
                                    <div class="font-bold text-red-500" id="fin-cost-usd">-$0.00</div>
                                    <div class="text-[10px] text-red-300 font-mono" id="fin-cost-lkr">Rs. 0.00</div>
                                </div>
                            </div>
                            <div class="flex justify-between items-center bg-green-50 p-3 rounded-xl border border-green-100 mt-2">
                                <span class="text-green-800 font-bold text-xs uppercase tracking-wider">Net Profit</span>
                                <div class="text-right">
                                    <div class="font-bold text-green-700 text-sm" id="fin-profit-usd">$0.00</div>
                                    <div class="font-bold text-green-600 text-[10px] font-mono" id="fin-profit-lkr">Rs. 0.00</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button onclick="confirmRun('This will delete all data. Are you sure?', triggerReset, 'danger')" class="w-full bg-white border border-red-200 text-red-500 hover:bg-red-50 hover:text-red-600 font-bold py-3 rounded-xl shadow-sm transition active:scale-95 flex items-center justify-center gap-2 text-xs uppercase tracking-widest mt-2">
                        <i class="fa-solid fa-trash-can"></i> Reset All Data
                    </button>
                </div><!-- Right Panel: Active Tasks -->
                <div class="md:w-2/3 flex flex-col bg-slate-50 rounded-2xl border border-gray-200 p-3 overflow-hidden shadow-inner">
                    <div class="flex justify-between items-center px-2 mb-3">
                        <h3 class="font-bold text-gray-700 text-sm uppercase tracking-tight flex items-center gap-2">
                            <i class="fa-solid fa-list-check text-blue-500"></i> Active Tasks
                        </h3>
                        <span class="text-[10px] text-white bg-slate-400 px-2 py-1 rounded-full font-bold shadow-sm" id="active-count">0 Active</span>
                    </div>
                    <div id="active-tasks-container" class="task-list space-y-3 pb-20 md:pb-5 overflow-y-auto h-full pr-1"></div>
                </div>
            </div>
        </div>

        <!-- QC VIEW -->
        <div id="view-qc" class="hidden fade-in pb-10">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-end mb-6 border-b pb-4">
                    <div><h2 class="text-2xl font-bold text-gray-800 tracking-tight">Quality Check</h2><p class="text-xs text-gray-500 uppercase tracking-wide mt-1">Verify completed accounts</p></div>
                    <span class="bg-blue-100 text-blue-700 text-xs font-bold px-3 py-1 rounded-full uppercase">Pending</span>
                </div>
                <div id="qc-list-container" class="space-y-4"></div>
            </div>
        </div>

        <!-- PAYMENTS VIEW -->
        <div id="view-payments" class="hidden fade-in pb-10">
            <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Pending -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-orange-100">
                    <div class="flex justify-between items-center mb-6 pb-2 border-b border-orange-100">
                        <h2 class="text-lg font-bold text-orange-600 uppercase tracking-tight flex items-center gap-2">
                            <i class="fa-solid fa-clock"></i> Pending Pay
                        </h2>
                        <button onclick="confirmRun('Copy list?', () => copyEmailList('pending'), 'info')" class="text-[10px] bg-orange-50 border border-orange-200 text-orange-700 px-3 py-1.5 rounded-lg font-bold hover:bg-orange-100 active:scale-95 transition">Copy List</button>
                    </div>
                    <div id="payment-pending-list" class="space-y-3 max-h-[600px] overflow-y-auto pr-1 custom-scrollbar"></div>
                </div>
                <!-- Paid -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-green-100">
                    <div class="flex justify-between items-center mb-6 pb-2 border-b border-green-100">
                        <h2 class="text-lg font-bold text-green-600 uppercase tracking-tight flex items-center gap-2">
                            <i class="fa-solid fa-check-double"></i> Paid History
                        </h2>
                        <button onclick="confirmRun('Copy list?', () => copyEmailList('paid'), 'info')" class="text-[10px] bg-green-50 border border-green-200 text-green-700 px-3 py-1.5 rounded-lg font-bold hover:bg-green-100 active:scale-95 transition">Copy List</button>
                    </div>
                    <div id="payment-paid-list" class="space-y-3 max-h-[600px] overflow-y-auto pr-1 custom-scrollbar"></div>
                </div>
            </div>
        </div>

        <!-- ISSUES VIEW -->
        <div id="view-issues" class="hidden fade-in pb-10">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-end mb-6 border-b border-red-100 pb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 tracking-tight">Issues</h2>
                        <p class="text-xs text-red-500 font-bold uppercase tracking-wide mt-1">Failed / Not Registered</p>
                    </div>
                    <span class="bg-red-100 text-red-700 text-xs font-bold px-3 py-1 rounded-full uppercase">Action Required</span>
                </div>
                <div id="issues-list-container" class="space-y-3"></div>
            </div>
        </div>

        <!-- STOCK VIEW -->
        <div id="view-stock" class="hidden fade-in pb-10">
            <div class="max-w-5xl mx-auto">
                <div class="bg-white rounded-2xl shadow-lg p-5 mb-8 border border-slate-200 border-t-4 border-slate-800">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2 uppercase tracking-wide flex items-center gap-2"><i class="fa-solid fa-upload"></i> Bulk Upload</h2>
                    <textarea id="bulk-input" rows="5" class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 font-mono text-xs mb-4 bg-slate-50 transition" placeholder="Paste First name, Email, and Password lines here..."></textarea>
                    <button onclick="confirmRun('Process this stock batch?', processBulkUpload, 'info')" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3.5 rounded-xl transition active:scale-95 shadow-lg shadow-slate-200 uppercase tracking-widest text-sm">Process & Add Stock</button>
                </div>
                
                <div class="bg-white rounded-2xl shadow overflow-hidden border border-slate-200">
                    <div class="px-5 py-4 border-b bg-slate-50 font-bold text-slate-700 text-sm uppercase tracking-wide flex justify-between items-center">
                        <span>Database Inventory</span>
                        <span class="text-[10px] bg-white border px-2 py-0.5 rounded text-slate-500">Live</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs text-left">
                            <thead class="bg-slate-100 text-slate-600 uppercase tracking-wider font-bold">
                                <tr>
                                    <th class="px-5 py-3">ID</th>
                                    <th class="px-5 py-3">Email Identity</th>
                                    <th class="px-5 py-3">Status</th>
                                    <th class="px-5 py-3">Date</th>
                                    <th class="px-5 py-3 text-center">Paid</th>
                                </tr>
                            </thead>
                            <tbody id="stock-table-body" class="divide-y divide-gray-100 font-medium text-slate-600"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 z-[100] bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl transition-all duration-300 opacity-0 pointer-events-none text-sm font-bold flex items-center gap-2 border border-slate-700">
        <i class="fa-solid fa-circle-check text-green-400 text-lg"></i><span id="toast-msg">Copied!</span>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // CONFIGURATION
        const SUPABASE_URL = 'https://eeowqtejbpwwvadfsolb.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_GAIEmObWY9BcV4ZBNEwM4g_tQhtF7KY';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let stockData = [];
        let activeTabId = 'dashboard';
        
        // Settings State
        let currentUsdRate = 300;
        let currentRevenue = 0.25;
        let currentWorkerPay = 40; 

        // Initialize App
        async function initApp() {
            showLoading(true);
            await Promise.all([loadData(), loadSettings()]);
            showLoading(false);
        }

        // Live Fetch from Supabase
        async function loadData() {
            try {
                const { data, error } = await supabaseClient.from('g_stock').select('*').order('id', { ascending: true });
                if (!error) { stockData = data || []; updateUI(); }
            } catch (err) { console.error('Load Error:', err); }
        }

        // Settings (USD Rate, Revenue, Pay)
        async function loadSettings() {
            try {
                const { data, error } = await supabaseClient.from('app_settings').select('*');
                if (data) {
                    data.forEach(setting => {
                        if (setting.key === 'usd_rate') currentUsdRate = parseFloat(setting.value);
                        if (setting.key === 'revenue') currentRevenue = parseFloat(setting.value);
                        if (setting.key === 'worker_pay') currentWorkerPay = parseFloat(setting.value);
                    });
                    
                    // Update Inputs
                    document.getElementById('usd-rate').value = currentUsdRate;
                    document.getElementById('revenue-rate').value = currentRevenue;
                    document.getElementById('worker-pay').value = currentWorkerPay;
                }
            } catch (err) {}
        }

        async function saveSettings() {
            const newRate = document.getElementById('usd-rate').value;
            const newRevenue = document.getElementById('revenue-rate').value;
            const newWorkerPay = document.getElementById('worker-pay').value;

            currentUsdRate = parseFloat(newRate) || 0;
            currentRevenue = parseFloat(newRevenue) || 0;
            currentWorkerPay = parseFloat(newWorkerPay) || 0;

            await supabaseClient.from('app_settings').upsert([
                { key: 'usd_rate', value: currentUsdRate.toString() },
                { key: 'revenue', value: currentRevenue.toString() },
                { key: 'worker_pay', value: currentWorkerPay.toString() }
            ]);
            updateUI(); 
        }

        // Subscriptions for Live Updates
        supabaseClient.channel('public:g_stock').on('postgres_changes', { event: '*', schema: 'public', table: 'g_stock' }, () => loadData()).subscribe();

        // --- HELPERS ---
        const getVisualID = (realID) => {
             const sorted = [...stockData].sort((a,b) => a.id - b.id);
             const index = sorted.findIndex(item => item.id === realID);
             return index !== -1 ? index + 1 : realID;
        };

        const getCalendarDate = (dateStr) => {
            if(!dateStr) return "";
            const d = new Date(dateStr);
            return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
        };

        const getRelativeDateLabel = (dateStr) => {
            if(!dateStr) return ""; const d = new Date(dateStr); const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
            const target = new Date(d.getFullYear(), d.getMonth(), d.getDate());
            if (target.getTime() === today.getTime()) return "Today";
            if (target.getTime() === yesterday.getTime()) return "Yesterday";
            return target.toISOString().split('T')[0];
        };

        const formatCurrency = (val) => {
             return val.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        // --- CONFIRMATION SYSTEM ---
        let pendingAction = null;
        function confirmRun(msg, action, type = 'info') {
            const m = document.getElementById('confirm-modal');
            const title = document.getElementById('modal-title');
            const btnYes = document.getElementById('modal-btn-yes');
            const iconBg = document.getElementById('modal-icon-bg');
            const icon = document.getElementById('modal-icon');
            const topLine = document.getElementById('modal-top-line');

            document.getElementById('modal-desc').innerText = msg;
            
            if (type === 'danger') {
                title.innerText = "Warning: Delete Data?";
                title.className = "text-xl font-bold text-red-600 mb-2";
                btnYes.className = "flex-1 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl active:scale-95 transition shadow-lg shadow-red-200 text-sm";
                btnYes.innerText = "Yes, Delete";
                iconBg.className = "mb-5 bg-red-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto shadow-sm";
                icon.className = "fa-solid fa-triangle-exclamation text-4xl text-red-500";
                topLine.className = "absolute top-0 left-0 w-full h-2 bg-red-500";
            } else {
                title.innerText = "Confirm Action";
                title.className = "text-xl font-bold text-gray-800 mb-2";
                btnYes.className = "flex-1 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl active:scale-95 transition shadow-lg shadow-blue-200 text-sm";
                btnYes.innerText = "Confirm";
                iconBg.className = "mb-5 bg-blue-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto shadow-sm";
                icon.className = "fa-solid fa-circle-question text-4xl text-blue-500";
                topLine.className = "absolute top-0 left-0 w-full h-2 bg-blue-500";
            }

            m.style.display = 'flex';
            pendingAction = action;
        }

        document.getElementById('modal-btn-yes').onclick = () => {
            document.getElementById('confirm-modal').style.display = 'none';
            if (pendingAction) pendingAction();
        };
        document.getElementById('modal-btn-cancel').onclick = () => document.getElementById('confirm-modal').style.display = 'none';

        // --- CORE FUNCTIONS ---
        async function processBulkUpload() {
            const text = document.getElementById('bulk-input').value; if(!text.trim()) return;
            const lines = text.split('\n'); let current = {}; let toAdd = [];
            let duplicates = 0; 

            lines.forEach(line => {
                const t = line.trim();
                if (t.toLowerCase().includes("first name")) current.fn = t.split(/:(.+)/)[1].trim();
                else if (t.toLowerCase().includes("email")) current.em = t.split(/:(.+)/)[1].trim();
                else if (t.toLowerCase().includes("password")) current.ps = t.split(/:(.+)/)[1].trim();
                
                if(current.em && current.ps) {
                    if (stockData.some(i => i.email === current.em)) {
                        duplicates++; 
                    } else {
                        if (!toAdd.some(i => i.email === current.em)) {
                            toAdd.push({ firstname: current.fn || '', email: current.em, pass: current.ps, status: 'available' });
                        }
                    }
                    current = {};
                }
            });

            if (duplicates > 0) {
                showToast(`${duplicates} Duplicates Skipped!`, "orange");
            }

            if (toAdd.length > 0) { 
                showLoading(true); 
                await supabaseClient.from('g_stock').insert(toAdd); 
                document.getElementById('bulk-input').value = ""; 
                showLoading(false); 
                loadData(); 
                showToast(`${toAdd.length} Stock Added!`); 
            } else if (duplicates > 0 && toAdd.length === 0) {
            } else {
                showToast("No valid data found", "red");
            }
        }

        async function getNewAccount() {
            const acc = stockData.find(i => i.status === 'available');
            if (!acc) { document.getElementById('error-msg').classList.remove('hidden'); return; }
            showLoading(true); await supabaseClient.from('g_stock').update({ status: 'processing', updated_at: new Date().toISOString() }).eq('id', acc.id);
            showLoading(false); loadData();
            setTimeout(() => {
                 const container = document.getElementById('active-tasks-container');
                 container.scrollTop = container.scrollHeight;
                 if(window.innerWidth < 768) window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            }, 300);
        }

        async function updateRecord(id, updates) { 
            showLoading(true); await supabaseClient.from('g_stock').update({...updates, updated_at: new Date().toISOString()}).eq('id', id);
            showLoading(false); loadData();
        }

        async function triggerReset() {
             showLoading(true);
             try { 
                const { error: rpcError } = await supabaseClient.rpc('reset_db');
                if (rpcError) await supabaseClient.from('g_stock').delete().neq('id', 0);
                showToast("Reset Complete!");
             } catch(e) {}
             showLoading(false); loadData(); 
        }

        // --- TAB & UI CONTROL ---
        function switchTab(t) {
            document.querySelectorAll('main > div[id^="view-"]').forEach(d => d.classList.add('hidden'));
            document.getElementById('view-' + t).classList.remove('hidden');
            document.querySelectorAll('nav button').forEach(b => b.className = "nav-btn flex-1 md:flex-none min-w-[90px] px-4 py-2.5 rounded-lg text-xs font-bold uppercase tracking-wider transition-all duration-200 text-gray-400 hover:bg-slate-800 hover:text-white border border-slate-700");
            const activeBtn = document.getElementById('btn-' + t);
            if(activeBtn) activeBtn.className = "nav-btn flex-1 md:flex-none min-w-[100px] px-4 py-2.5 rounded-lg text-xs font-bold uppercase tracking-wider transition-all duration-200 bg-blue-600 text-white shadow-md";
            activeTabId = t; updateUI();
        }

        function updateUI() {
            const s = {
                avail: stockData.filter(i => i.status === 'available').length,
                proc: stockData.filter(i => i.status === 'processing').length,
                comp: stockData.filter(i => i.status === 'completed').length,
                verif: stockData.filter(i => i.status === 'qc_approved').length,
                paid: stockData.filter(i => i.status === 'qc_approved' && i.paid).length,
                iss: stockData.filter(i => i.status === 'failed' || i.status === 'qc_wrong_pass').length
            };
            document.getElementById('stat-available').innerText = s.avail;
            document.getElementById('stat-progress').innerText = s.proc;
            document.getElementById('stat-completed').innerText = s.comp;
            document.getElementById('stat-verified').innerText = s.verif;
            document.getElementById('stat-paid').innerText = s.paid;
            document.getElementById('stat-issues').innerText = s.iss;
            
            // FIXED CALCULATION (Revenue in USD, Worker Cost in LKR)
            const revenueUSD = s.verif * currentRevenue;
            const workerCostLKR = s.verif * currentWorkerPay;
            
            const totalRevenueLKR = revenueUSD * currentUsdRate;
            const profitLKR = totalRevenueLKR - workerCostLKR;
            
            const workerCostUSD = (currentUsdRate > 0) ? (workerCostLKR / currentUsdRate) : 0;
            const profitUSD = revenueUSD - workerCostUSD;

            document.getElementById('fin-revenue-usd').innerText = "$" + formatCurrency(revenueUSD);
            document.getElementById('fin-revenue-lkr').innerText = "Rs. " + formatCurrency(totalRevenueLKR);
            
            document.getElementById('fin-cost-usd').innerText = "-$" + formatCurrency(workerCostUSD);
            document.getElementById('fin-cost-lkr').innerText = "Rs. " + formatCurrency(workerCostLKR);
            
            document.getElementById('fin-profit-usd').innerText = "$" + formatCurrency(profitUSD);
            document.getElementById('fin-profit-lkr').innerText = "Rs. " + formatCurrency(profitLKR);

            renderActiveTasks(); renderQCList(); renderPaymentLists(); renderIssuesList(); renderAdminTable();
        }

        function renderActiveTasks() {
            const container = document.getElementById('active-tasks-container');
            const tasks = stockData.filter(i => i.status === 'processing');
            document.getElementById('active-count').innerText = tasks.length + " Active";
            container.innerHTML = tasks.map(t => `<div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 hover:shadow-md transition">
                <div class="flex justify-between mb-3 items-center">
                    <button onclick="copyAllDetails('${t.id}')" class="text-[10px] bg-blue-50 text-blue-700 font-bold px-3 py-1.5 rounded-lg border border-blue-100 hover:bg-blue-100 transition">COPY DATA</button>
                    <span class="text-xs font-bold text-slate-400">#${getVisualID(t.id)}</span>
                </div>
                <div class="bg-blue-50/50 p-2 rounded-lg border border-blue-50 mb-3">
                     <div class="text-[10px] text-blue-400 font-bold uppercase">First Name</div>
                     <div class="font-bold text-slate-800 text-sm">${t.firstname || 'User'}</div>
                </div>
                <div class="space-y-2 mb-5">
                    <div class="flex justify-between bg-slate-50 p-2 rounded-lg font-mono text-xs items-center border border-slate-100">
                        <span class="truncate pr-2">${t.email}</span>
                        <button onclick="copyToClipboard('${t.email}')" class="bg-white p-1.5 rounded shadow-sm border border-slate-200 hover:text-blue-600 transition"><i class="fa-regular fa-copy"></i></button>
                    </div>
                    <div class="flex justify-between bg-slate-50 p-2 rounded-lg font-mono text-xs items-center border border-slate-100">
                        <span class="truncate pr-2 text-slate-600">${t.pass}</span>
                        <button onclick="copyToClipboard('${t.pass}')" class="bg-white p-1.5 rounded shadow-sm border border-slate-200 hover:text-blue-600 transition"><i class="fa-regular fa-copy"></i></button>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="confirmRun('Mark as Registered?', () => updateRecord('${t.id}', {status:'completed'}), 'info')" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl text-xs shadow-sm transition active:scale-95 uppercase tracking-wide">Registered</button>
                    <button onclick="confirmRun('Mark as Not Registered?', () => updateRecord('${t.id}', {status:'failed'}), 'info')" class="flex-1 bg-white border-2 border-red-100 text-red-500 hover:bg-red-50 font-bold py-3 rounded-xl text-xs transition active:scale-95 uppercase tracking-wide">Not Registered</button>
                </div>
            </div>`).join('') || '<div class="h-60 flex flex-col items-center justify-center text-slate-300 gap-2"><i class="fa-solid fa-list-check text-4xl mb-2"></i><p class="text-sm font-bold uppercase tracking-wide">No Active Tasks</p></div>';
        }

        function renderQCList() {
            const container = document.getElementById('qc-list-container');
            const items = stockData.filter(i => i.status === 'completed');
            let h = '';
            items.forEach(i => {
                h += `<div class="bg-white p-4 rounded-xl border border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4 shadow-sm hover:shadow-md transition"><div class="flex-1 w-full overflow-hidden"><div class="text-[10px] font-bold text-slate-400 mb-1">#${getVisualID(i.id)} - REGISTERED</div><div class="space-y-2 mt-2"><div class="flex items-center gap-2 bg-slate-50 p-2.5 rounded-lg border border-slate-100 font-mono text-xs overflow-hidden"><span class="truncate flex-1 text-slate-700">${i.email}</span><button onclick="copyToClipboard('${i.email}')" class="text-slate-400 hover:text-blue-600"><i class="fa-regular fa-copy text-lg"></i></button></div><div class="flex items-center gap-2 bg-slate-50 p-2.5 rounded-lg border border-slate-100 font-mono text-xs overflow-hidden"><span class="truncate flex-1 text-slate-700">${i.pass}</span><button onclick="copyToClipboard('${i.pass}')" class="text-slate-400 hover:text-blue-600"><i class="fa-regular fa-copy text-lg"></i></button></div></div></div><div class="flex gap-2 shrink-0 w-full md:w-auto mt-2 md:mt-0"><button onclick="confirmRun('Verify Account?', () => updateRecord('${i.id}', {status:'qc_approved'}), 'info')" class="flex-1 md:flex-none bg-emerald-500 hover:bg-emerald-600 text-white font-bold px-6 py-2.5 rounded-xl text-xs shadow-sm active:scale-95 uppercase tracking-wide">Verify OK</button><button onclick="confirmRun('Mark Wrong Password?', () => updateRecord('${i.id}', {status:'qc_wrong_pass'}), 'info')" class="flex-1 md:flex-none bg-white border border-red-200 text-red-500 hover:bg-red-50 font-bold px-6 py-2.5 rounded-xl text-xs transition active:scale-95 uppercase tracking-wide">Wrong Pass</button><button onclick="confirmRun('Mark Not Registered?', () => updateRecord('${i.id}', {status:'failed'}), 'info')" class="flex-1 md:flex-none bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold px-4 py-2.5 rounded-xl text-xs transition active:scale-95 uppercase tracking-wide">Not Reg</button></div></div>`;
            });
            container.innerHTML = h || '<div class="text-center py-20 bg-white rounded-xl border border-dashed border-slate-200"><i class="fa-solid fa-clipboard-check text-4xl text-slate-200 mb-2"></i><p class="text-slate-400 italic">No pending QC checks</p></div>';
        }

        function renderPaymentLists() {
            const pendingList = document.getElementById('payment-pending-list');
            const paidList = document.getElementById('payment-paid-list');
            const pending = stockData.filter(i => i.status === 'qc_approved' && !i.paid);
            let paid = stockData.filter(i => i.status === 'qc_approved' && i.paid);
            paid.sort((a,b) => new Date(b.updated_at) - new Date(a.updated_at));

            let hPen = '';
            pending.forEach(i => {
                hPen += `<div class="bg-white p-3 rounded-xl border border-orange-100 flex justify-between items-center shadow-sm hover:shadow-md transition mb-2"><div class="flex flex-col"><div class="flex items-center gap-2 mb-1"><span class="text-[10px] font-bold bg-slate-100 text-slate-500 px-1.5 rounded">#${getVisualID(i.id)}</span></div><div class="flex items-center gap-2"><span class="text-xs font-mono font-medium text-slate-700 truncate w-32 md:w-48">${i.email}</span><button onclick="copyToClipboard('${i.email}')" class="text-gray-400 hover:text-blue-500"><i class="fa-regular fa-copy"></i></button></div></div><button onclick="confirmRun('Mark as Paid?', () => togglePayment('${i.id}'), 'info')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wide shadow-sm active:scale-95 transition">Pay</button></div>`;
            });
            pendingList.innerHTML = hPen || '<p class="text-slate-400 text-xs py-10 text-center italic border border-dashed rounded-xl">No pending payments</p>';

            let hPaid = '', lastG = null;
            paid.forEach(i => {
                const g = getRelativeDateLabel(i.updated_at);
                if(g !== lastG) { hPaid += `<div class="text-[10px] font-bold text-slate-400 uppercase mt-4 mb-2 border-b border-slate-100 tracking-widest pl-1">${g}</div>`; lastG = g; }
                hPaid += `<div class="bg-slate-50 p-2 rounded flex justify-between items-center mb-1 hover:bg-white border border-transparent hover:border-blue-100 transition"><div class="flex items-center gap-2 text-gray-500 overflow-hidden"><span class="font-mono text-[10px] font-bold">#${getVisualID(i.id)}</span><span class="text-xs font-mono line-through decoration-slate-300 text-slate-400 truncate w-32 md:w-48 font-mono">${i.email}</span><button onclick="copyToClipboard('${i.email}')" class="text-gray-400 hover:text-blue-500 px-1"><i class="fa-regular fa-copy"></i></button></div><button onclick="confirmRun('Undo Payment?', () => togglePayment('${i.id}'), 'info')" class="text-[10px] text-red-400 hover:text-red-600 font-bold border border-red-50 hover:bg-red-50 px-2 py-1 rounded transition">Undo</button></div>`;
            });
            paidList.innerHTML = paid.length ? `<div class="mb-4 bg-emerald-50 text-emerald-700 px-3 py-2 rounded-lg text-xs font-bold text-center border border-emerald-100">Total Paid Items: ${paid.length}</div>` + hPaid : '<p class="text-slate-400 text-xs py-10 text-center italic border border-dashed rounded-xl">No payment history</p>';
        }

        function renderIssuesList() {
            document.getElementById('issues-list-container').innerHTML = stockData.filter(i => i.status === 'failed' || i.status === 'qc_wrong_pass').map(i => `<div class="bg-white p-4 rounded-xl border border-red-100 flex justify-between items-center shadow-sm hover:shadow-md transition"><div><div class="flex items-center gap-2 mb-1"><span class="bg-red-50 text-red-600 text-[10px] font-bold px-2 py-0.5 rounded border border-red-100 uppercase tracking-tight">${i.status === 'failed' ? 'Not Registered' : 'Wrong Password'}</span><span class="text-[10px] text-slate-400 font-bold">#${getVisualID(i.id)}</span></div><div class="text-xs font-mono text-slate-700 font-medium">${i.email}</div></div><button onclick="confirmRun('Send to QC again?', () => updateRecord('${i.id}', {status:'completed'}), 'info')" class="bg-amber-50 border border-amber-200 text-amber-700 hover:bg-amber-100 px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wide active:scale-95">To QC</button></div>`).join('') || '<div class="text-center py-20 bg-white rounded-xl border border-dashed border-slate-200"><i class="fa-regular fa-circle-check text-4xl text-green-200 mb-2"></i><p class="text-slate-400 italic">No issues reported</p></div>';
        }

        function renderAdminTable() {
            let items = [...stockData].reverse().slice(0, 50); 
            document.getElementById('stock-table-body').innerHTML = items.map(i => {
                let badge = "bg-slate-100 text-slate-600";
                if(i.status === 'available') badge = "bg-blue-50 text-blue-600 border border-blue-100"; else if(i.status === 'processing') badge = "bg-yellow-50 text-yellow-600 border border-yellow-100"; else if(i.status === 'qc_approved') badge = "bg-green-100 text-green-600 border border-green-100"; else if(i.status.includes('fail') || i.status.includes('wrong')) badge = "bg-red-50 text-red-600 border border-red-100";
                
                let displayStatus = i.status.replace('qc_', '').toUpperCase();
                if (i.status === 'failed') displayStatus = 'NOT REGISTERED';
                
                return `<tr class="hover:bg-slate-50 transition border-b border-slate-50 last:border-0"><td class="px-4 py-3.5 font-bold text-slate-400">#${getVisualID(i.id)}</td><td class="px-4 py-3.5"><div class="flex items-center gap-2"><span class="font-mono text-xs text-slate-700 truncate w-32 md:w-auto font-medium">${i.email}</span><button onclick="copyToClipboard('${i.email}')" class="text-slate-300 hover:text-blue-500 transition"><i class="fa-regular fa-copy"></i></button></div></td><td class="px-4 py-3.5"><span class="${badge} px-2 py-1 rounded text-[9px] uppercase font-bold tracking-wide">${displayStatus}</span></td><td class="px-4 py-3.5 text-slate-400 text-[10px] font-medium">${getCalendarDate(i.created_at)}</td><td class="px-4 py-3.5 text-center">${i.paid ? '<i class="fa-solid fa-circle-check text-indigo-500 text-sm"></i>' : '<span class="w-2 h-2 rounded-full bg-slate-200 inline-block"></span>'}</td></tr>`;
            }).join('') || '<tr><td colspan="5" class="py-10 text-center text-slate-400 italic">No Data Available</td></tr>';
        }

        // Global Handlers
        function handleSearch() {
            let q = document.getElementById('global-search').value.toLowerCase().trim();
            const btn = document.getElementById('clear-search-btn'); if(q) btn.classList.remove('hidden'); else btn.classList.add('hidden');
            if (q === "") { switchTab('dashboard'); return; }
            document.querySelectorAll('main > div[id^="view-"]').forEach(id => id.classList.add('hidden')); document.getElementById('view-search').classList.remove('hidden');
            let res = isNaN(q) ? stockData.filter(i => i.email.toLowerCase().includes(q)) : stockData.filter(item => getVisualID(item.id).toString() === q);
            document.getElementById('search-results-container').innerHTML = res.map(i => {
                let st = i.status.replace('qc_', '').toUpperCase(); if(st === 'FAILED') st = 'NOT REG';
                let cls = i.status.includes('fail') || i.status.includes('wrong') ? 'bg-red-50 border-red-200' : 'bg-white border-slate-200';
                let txt = i.status.includes('fail') || i.status.includes('wrong') ? 'text-red-600' : 'text-slate-600';
                
                if (i.status === 'qc_wrong_pass') { cls = "bg-red-50 border-red-200"; txt = "text-red-600"; } 
                else if (i.status === 'available') { cls = "bg-blue-50 border-blue-200"; txt = "text-blue-600"; }
                else if (i.status === 'processing') { cls = "bg-yellow-50 border-yellow-200"; txt = "text-yellow-600"; }
                else if (i.status === 'qc_approved') { cls = "bg-green-50 border-green-200"; txt = "text-green-600"; }

                return `<div class="${cls} p-4 rounded-xl border mb-2 flex justify-between items-center shadow-sm"><div class="flex-1 overflow-hidden"><div class="flex items-center gap-2 mb-1"><span class="font-bold text-xs text-slate-400">#${getVisualID(i.id)}</span><span class="${txt} text-[10px] uppercase font-bold px-2 py-0.5 bg-white/50 rounded border border-black/5">${st}</span></div><div class="font-mono text-xs text-slate-800 font-bold truncate">${i.email}</div></div><button onclick="copyAllDetails('${i.id}')" class="ml-3 text-blue-500 bg-blue-50 p-2.5 rounded-lg hover:bg-blue-100 transition"><i class="fa-regular fa-clipboard text-lg"></i></button></div>`;
            }).join('') || '<p class="text-center py-20 text-slate-400 font-medium">No matches found</p>';
        }

        function clearSearch() { document.getElementById('global-search').value = ''; handleSearch(); }
        function togglePayment(id) { const acc = stockData.find(i => i.id == id); if(acc) updateRecord(id, { paid: !acc.paid }); }
        function showLoading(s) { document.getElementById('loading-overlay').style.display = s ? 'flex' : 'none'; }
        function showToast(m, c = 'slate') { const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText = m; t.style.opacity = '1'; t.style.transform = 'translate(-50%, 0)'; setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translate(-50%, 20px)'; }, 2000); }
        function copyToClipboard(t) { const el = document.createElement('textarea'); el.value = t; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); showToast("Copied!"); }
        function copyAllDetails(id) { const acc = stockData.find(i => i.id == id); if(acc) { const vid = getVisualID(acc.id); copyToClipboard(`#${vid}\nName: ${acc.firstname}\nEmail: ${acc.email}\nPassword: ${acc.pass}`); } }
        function copyEmailList(type) { const list = stockData.filter(i => i.status === 'qc_approved' && (type === 'pending' ? !i.paid : i.paid)); if(list.length) { copyToClipboard(list.map(i => i.email).join('\n')); showToast("Emails Copied!"); } else showToast("Nothing to copy"); }

        window.onload = initApp;
    </script>
</body>
</html>